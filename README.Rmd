---
title: "README"
output: 
  html_document:
    keep_md: yes
    code_folding: hide
    toc: true
    toc_float: true
    toc_depth: 4
author: "Marcus W. Beck, beck.marcus@epa.gov"
---
```{r warning = F, message = F}
library(tidyverse)
library(readxl)
library(plotly)
library(forcats)
source('R/funcs.R')
```

### Files

**_data/_** Supporting RData files, usually from data in ignore folder, unless otherwise noted all files were created in `R/dat_proc.R`

* `conv.RData` data frame with coral morphological conversion factors

* `crl_abu.RData` USEPA 2011 coral demographic survey from PR

### Stony coral metrics

#### Percent live cover

This was estimated at each station as the average live cover of all colonies at a site.  The live cover of a colony was the sum of the estimated surface area of all species in a colony that was reported as percent live (reciprocal of the sum of new and old percent mortality).  Surface area of an individual was estimated from the reported diameter and height using one of three approaches: log-linear surface area equations, standard surface area equation using conversion factors, and surface area of a sphere having the same diameter.  The last equation was used only if equations in the first two options were unavailable for a species. The diameter for species with different values for maximum and perpendicular reported diameters was converted to a single value that was a circle with the same area as an ellipse based on the two diameters.  

```{r cache = T}
# transect data
crl_dem <- read.csv(
  'L:/lab/Coral_EcoSystems/BCG/D. Data/NOAA Data/2014/Data/PR data/Gibbs 081716/NCRMP_PR2014_CoralDemo_FINAL.csv', 
  stringsAsFactors = F
  ) %>%
  select(station_code, latitude, longitude, species_name, ColonyID, MaxDiam, PerpDiam, Height, MortOld, MortNew, Bleached, Diseased)

# coral cover 
csa <- select(crl_dem, station_code, species_name, ColonyID, MaxDiam, PerpDiam, Height) %>% 
  group_by(station_code, species_name, ColonyID) %>% 
  mutate(
    csa = ifelse(MaxDiam != -1, est_3d(species_name, Height, MaxDiam, PerpDiam), -1)
  ) %>% 
  ungroup %>% 
  select(station_code, species_name, ColonyID, csa)

# coral live surface area
csa_live <- select(crl_dem, station_code, species_name, ColonyID, MortOld, MortNew) %>% 
  left_join(., csa, by = c('station_code', 'species_name', 'ColonyID')) %>% 
  group_by(station_code, species_name, ColonyID) %>% 
  mutate(LCSA = ifelse(csa != -1, csa * (1 - sum(MortOld + MortNew) / 100), -1)) %>% 
  group_by(station_code, ColonyID) %>% 
  summarise(LCSA = sum(pmax(0, LCSA)) / sum(pmax(0, csa))) %>% 
  group_by(station_code) %>% 
  summarise(LCSA = sum(LCSA) / length(unique(ColonyID)))
```

```{r warning = F, message = F, fig.height = 4, fig.width = 8}
mythm <- theme_minimal() +
  theme(
    legend.position = 'top', 
    legend.title = element_blank(),
    panel.border = element_rect(colour = "black", fill = NA, size = 0.5),
    axis.ticks.x = element_line(),
    axis.ticks.y = element_line(),
    axis.ticks.length = unit(.1, "cm"), 
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank()
  )  

p <- ggplot(csa_live, aes(x = LCSA)) + 
  geom_histogram() + 
  mythm
ggplotly()
```

```{r warning = F, message = F, fig.height = 4, fig.width = 8}
mythm <- theme_minimal() +
  theme(
    legend.position = 'top', 
    legend.title = element_blank(),
    panel.border = element_rect(colour = "black", fill = NA, size = 0.5),
    axis.ticks.x = element_line(),
    axis.ticks.y = element_line(),
    axis.ticks.length = unit(.1, "cm"), 
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(), 
    axis.text.x = element_text(size = 6)
  )  
toplo <- filter(csa_live, !is.na(LCSA)) %>% 
  arrange(LCSA) %>% 
  mutate(station_code = factor(station_code, levels = as.character(station_code)))
p <- ggplot(toplo, aes(x = station_code, y = LCSA)) +
  geom_bar(stat = 'identity') +
  mythm + 
  scale_x_discrete('Station')
ggplotly()
```

#### Mortality of large reef-building genera

Mortality of large reef-building genera (*Acropora*, *Colpophyllia*, *Dendrogrya*, *Orbicella*, *Pseudodiploria*) was estimated as the average recent mortality at the site for all individuals within the genera. This value is reported as the average percent live surface area and was estimated similarly as above, except the estimates are averages of all individuals and not per colony.  Note that some sites did not include these genera. The table below shows sites where recent mortality was observed.   

```{r cache = T, message = F}
# coral live surface area, colony averages by site
lrg_mort<- select(crl_dem, station_code, species_name, ColonyID, MortOld, MortNew) %>% 
  left_join(., csa, by = c('station_code', 'species_name', 'ColonyID')) %>% 
  group_by(station_code, species_name, ColonyID) %>% 
  filter(csa != -1) %>% 
  mutate(
    LCSA = csa * (1 - MortNew / 100),
    lrg_sp = ifelse(grepl('^Acropora|^Colpophyllia|^Dendrogyra|^Orbicella|^Pseudodiploria', species_name), 1, 0)
    ) %>% 
  group_by(station_code, lrg_sp) %>% 
  summarize(
    mort = mean(LCSA/csa)
  ) %>% 
  ungroup %>% 
  complete(station_code, lrg_sp) %>% 
  filter(lrg_sp == 1)

totab <- filter(lrg_mort, mort < 1) %>% 
  arrange(mort) %>% 
  rename(
    Station = station_code, 
    `Large genera present` = lrg_sp, 
    `Average LCSA for large genera` = mort
  )
pander::pander(totab)
```

#### Frequency distribution of colony size

This describes the variation in colony sizes at a site, where sites with higher BCG levels have a more even distribution of small to large colonies.  Presence of recruits is also taken into consideration for BCG quality.  The plot below shows the stations ranked from smallest to largest total colony size with bars stacked from smallest to largest colony at a station. The second plot shows an example for a subset of the stations.   

```{r warning = F, message = F, fig.height = 5, fig.width = 8}
# frequency distribution of colony sizes
col_sz <- select(crl_dem, station_code, species_name, ColonyID, MortOld, MortNew) %>% 
  left_join(., csa, by = c('station_code', 'species_name', 'ColonyID')) %>% 
  group_by(station_code, ColonyID) %>% 
  summarise(
    Recruits = factor(ifelse(any(csa < 0), 1, 0)),
    csa = sum(pmax(0, csa))
  ) %>% 
  group_by(station_code)
tmp <- summarise(col_sz, tot = sum(csa, na.rm = T)) %>% 
  .$tot %>% 
  order
col_sz <- ungroup(col_sz) %>% 
  mutate(
    station_code = as.character(station_code),
    station_code = factor(station_code, levels = unique(station_code)[tmp])
    ) %>% 
  filter(!is.na(csa)) %>% 
  arrange(station_code, csa) %>%
  unite('statcol', station_code, ColonyID, sep = '_', remove = F) %>% 
  mutate(statcol = factor(statcol, levels = as.character(statcol)))

mythm <- theme_minimal() +
  theme(
    legend.position = 'top', 
    panel.border = element_rect(colour = "black", fill = NA, size = 0.5),
    axis.ticks.x = element_line(),
    axis.ticks.y = element_line(),
    axis.ticks.length = unit(.1, "cm"), 
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(), 
    axis.text.x = element_text(size = 6)
  )  

p <- ggplot(col_sz, aes(x = station_code, y = csa, group = factor(statcol), fill = Recruits)) + 
  geom_bar(stat = 'identity', colour = 'grey') + 
  mythm +
  theme(legend.position = 'top') + 
  scale_x_discrete('Station') + 
  scale_y_continuous('CSA')
  
ggplotly()

set.seed(123)
tmp <- filter(col_sz, station_code %in% sample(station_code, 4))
p <- ggplot(tmp, aes(x = station_code, y = csa, group = factor(statcol), fill = Recruits)) + 
  geom_bar(stat = 'identity', position = 'dodge', colour = 'grey') + 
  mythm +
  theme(legend.position = 'top') + 
  scale_x_discrete('Station') + 
  scale_y_continuous('CSA')
ggplotly()
```

#### Sensitive and rare species

This metric assesses the species composition and diversity of sensitive, rare species present (*Eusmilia*, *Isophyllastrea*, *Isophyllia*, *Mycetophyllia*, *Scolymia*) in the appropriate habitat type. The metric could be evaluated at each site as a richness estimate for the sensitive species, sum of the relative abundances, or as a diversity measure that accounts for both richness and abundance. Relative abundance was estimated as the number of observations for a species divided by the total number of observations. Diversity of sensitive species was estimated as Shannon diversity. Only sixteen stations had sensitive species.

```{r warning = F, message = F, fig.height = 3, fig.width = 8}
# relative abundance
rel_abu <- select(crl_dem, station_code, species_name, ColonyID) %>% 
  group_by(station_code, species_name) %>% 
  summarise(
    spp_abu = length(species_name)
  ) %>% 
  group_by(station_code) %>% 
  mutate( 
    rel_abu = spp_abu/sum(spp_abu)
  )

senssp <- c('^Eusmilia|^Isophyllastrea|^Isophyllia|^Mycetophyllia|^Scolymia')
sens <- group_by(rel_abu, station_code) %>% 
  summarise(
    rich = sum(grepl(senssp, species_name)),
    rel_abu = sum(rel_abu[grepl(senssp, species_name)]),
    div = vegan::diversity(spp_abu[grepl(senssp, species_name)])
  )

# summary table for those with sens species
totab <- filter(sens, rich > 0) %>% 
  rename(
    Station = station_code, 
    Richness = rich, 
    `Relative abundance` = rel_abu, 
    Diversity = div
    )
pander::pander(totab)

# bar plot of relative abundance
toplo <- arrange(totab, `Relative abundance`) %>% 
  mutate(Station = factor(Station, levels = as.character(Station)))
p <- ggplot(toplo, aes(x = Station, y = `Relative abundance`)) + 
  geom_bar(stat = 'identity') + 
  mythm
ggplotly()
```

#### Disease, bleaching

Disease was recorded for individual corals as present/absence bleaching was recorded as absent, partial, and total. Both were summarized at each site as percent of individuals with disease or bleaching, i.e., sum of presence divided by total individuals.  Indidividuals with partial bleaching were assigned a value of 0.5.

```{r warning = F, message = F, fig.height = 5, fig.width = 8}
# sick - disease, bleaching
sick <- select(crl_dem, station_code, species_name, Bleached, Diseased) %>% 
  mutate(
    Bleached = factor(Bleached), 
    Bleached = fct_recode(Bleached,
      'NA' = 'N/A', 
      '1' = 'T', 
      '0.5' = 'P',
      '0' = 'N'
    ), 
    Bleached = as.numeric(as.character(Bleached)),
    Diseased = factor(Diseased),
    Diseased = fct_recode(Diseased, 
      'NA' = 'N/A',
      '1' = 'P', 
      '0' = 'A'
    ), 
    Diseased = as.numeric(as.character(Diseased))
  ) %>% 
  group_by(station_code) %>% 
  summarise(
    Bleached = sum(Bleached, na.rm = T)/length(Bleached), 
    Diseased = sum(Diseased, na.rm = T)/length(Diseased) 
  )
  
toplo <- filter(sick, Diseased != 0 | Bleached != 0)  %>% 
  arrange(Bleached) %>% 
  mutate(station_code = factor(station_code, levels = as.character(station_code))) %>% 
  gather('var', 'val', Bleached:Diseased)

p <- ggplot(toplo, aes(x = station_code, y = val)) + 
  geom_bar(stat = 'identity') + 
  facet_wrap(~var, ncol = 1) + 
  scale_y_continuous('Proportion') + 
  scale_x_discrete('Station') + 
  mythm
ggplotly()
```

#### Dominance of *Orbicella* and *Acropora*

Dominance of *Orbicella* and *Acropora* genera was assessed as the sum of relative abundances of species at each site. This metric also refers to structural dominance of the species so it was also assessed as the sum of the surface area of all species in the genera divided by the total. 

```{r warning = F, message = F, fig.height = 5, fig.width = 8}
gens <- '^Acropora|^Orbicella'
acrorb_abu <- summarise(rel_abu,
  rel_abu = sum(rel_abu[grepl(gens, species_name)])
  )
acrorb_csa <- mutate(csa, csa = ifelse(csa == -1, 0, csa)) %>% 
  group_by(station_code) %>% 
  summarise(
    rel_csa = sum(csa[grepl(gens, species_name)]),
    rel_csa = rel_csa/sum(csa), 
    rel_csa = ifelse(is.na(rel_csa), 0, rel_csa)
    )
acrorb <- full_join(acrorb_abu, acrorb_csa, by = 'station_code')

toplo <- filter(acrorb, rel_abu != 0 & rel_csa != 0) %>% 
  arrange(rel_csa) %>% 
  mutate(station_code = factor(station_code, levels = as.character(station_code))) %>% 
  rename(
    `Relative abundance` = rel_abu,
    `Proportion CSA` = rel_csa
  ) %>% 
  gather('var', 'val', `Relative abundance`:`Proportion CSA`)
p <- ggplot(toplo, aes(x = station_code, y = val)) + 
  geom_bar(stat = 'identity') + 
  facet_wrap(~var, ncol = 1) + 
  scale_y_continuous('Proportion') + 
  scale_x_discrete('Station') + 
  mythm
ggplotly()
```

