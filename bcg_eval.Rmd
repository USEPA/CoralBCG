---
output: 
  html_document:
    keep_md: yes
    code_folding: hide
    toc: true
    toc_float: true
    toc_depth: 4
author: "Marcus W. Beck, beck.marcus@epa.gov"
---
```{r warning = F, message = F}
library(tidyverse)
library(readxl)
library(plotly)
library(forcats)
source('R/funcs.R')
```

### Stony coral metrics

#### Habitat distribution

Habitat data are included in the coral demographic surveys for each species record (row), one type per station.  Habitat descriptions are AGRF (linear reef), BDRK (bedrock), PTRF (patch reef), PVMT (pavement), and SCR (scattered coral/rock in sand).

```{r cache = T}
# transect data 
# select relevant columns, remove milipora
crl_dem <- read.csv(
  'L:/lab/Coral_EcoSystems/BCG/D. Data/NOAA Data/2014/Data/PR data/Gibbs 081716/NCRMP_PR2014_CoralDemo_FINAL.csv', 
  stringsAsFactors = F
  ) %>%
  select(station_code, latitude, longitude, habitat, species_name, ColonyID, MaxDiam, PerpDiam, Height, MortOld, MortNew, Bleached, Diseased) %>% 
  filter(!grepl('Millepora', species_name))

# coral metrics
crl_met <- get_stony_mets(crl_dem)

# habitat of each station (one per station)
habs <- select(crl_dem, station_code, habitat) %>% 
  group_by(station_code) %>% 
  summarise(habitat = unique(habitat))

mythm <- theme_minimal() +
  theme(
    legend.position = 'top', 
    legend.title = element_blank(),
    panel.border = element_rect(colour = "black", fill = NA, size = 0.5),
    axis.ticks.x = element_line(),
    axis.ticks.y = element_line(),
    axis.ticks.length = unit(.1, "cm"), 
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank()
  )  
p <- ggplot(habs, aes(x = habitat)) + 
  geom_bar(position = 'stack', stat = 'count') + 
  mythm
ggplotly()
```

#### Percent live cover

This was estimated at each station as the average live cover of all colonies at a site.  The live cover of a colony was the sum of the estimated surface area of all species in a colony that was reported as percent live (reciprocal of the sum of new and old percent mortality).  Surface area of an individual in each colony at each site was estimated as follows:

 1. Identify height, maximum diameter, and perpendicular diameter
 2. Convert maximum and perpendicular diameter to a single value as the diameter of a ciricle with the same area as an ellipse based on the major/minor axes
 3. Use morphological conversion factors if species name is not found in equation list, where conversion factors are based on Table J-1 in EPA/600/R-13/350 (same as Table 3-2 in EPA/600/R-12/029) and the equation 
$$
CSA = \pi \cdot r^2 \cdot M 
$$
$$
r = \frac{height + diam/2}{2}
$$

Percent live cover was then estimated as:

1. For each species, multiply the total surface area by the inverse of the mortality estimate
$$
LCSA = CSA \cdot \left(1 - \left(MortOld + MortNew\right)/100\right)
$$
2. For each colony, estimate the average LCSA across all species
3. For each station, estimate the average LCSA across all colonies

```{r warning = F, message = F, fig.height = 4, fig.width = 8}

# hist of lcsa
p <- ggplot(crl_met, aes(x = lcsa)) + 
  geom_histogram() + 
  mythm
ggplotly()

mythm <- mythm + 
  theme(axis.text.x = element_text(size = 5))

# barplot of lcsa
toplo <- arrange(crl_met, lcsa) %>% 
  mutate(station_code = factor(station_code, levels = as.character(station_code)))
p <- ggplot(toplo, aes(x = station_code, y = lcsa)) +
  geom_bar(stat = 'identity') +
  mythm + 
  scale_x_discrete('Station')
ggplotly()
```

#### Mortality of large reef-building genera

Mortality of large reef-building genera (*Acropora*, *Colpophyllia*, *Dendrogrya*, *Orbicella*, *Pseudodiploria*) was estimated as the average recent mortality at the site for all individuals within the genera. This value is reported as the average percent live surface area and was estimated similarly as above, except the estimates are averages of all individuals and not per colony.  Note that some sites did not include these genera. The table below shows sites where recent mortality was observed.   

```{r cache = T, message = F}
totab <- select(crl_met, station_code, lrg_mort, lrg_rich) %>% 
  filter(lrg_mort > 0) %>% 
  arrange(lrg_mort) %>% 
  rename(
    Station = station_code, 
    `Large species richness` = lrg_rich, 
    `Average recent mortality` = lrg_mort
  )
pander::pander(totab)
```

#### Frequency distribution of colony size

This describes the variation in colony sizes at a site, where sites with higher BCG levels have a more even distribution of small to large colonies.  Presence of recruits is also taken into consideration for BCG quality.  The plot below shows the stations ranked from smallest to largest total colony size with bars stacked from smallest to largest colony at a station. The second plot shows an example for a subset of the stations.   

```{r warning = F, message = F, fig.height = 5, fig.width = 8}
col_sz <- crl_dem %>% 
  mutate(
    csa = est_3d(species_name, Height, MaxDiam, PerpDiam)
  ) %>% 
  filter(!grepl('No Coral Observed', species_name)) %>% 
  get_col_sz
tmp <- group_by(col_sz, station_code) %>% 
  summarise(tot = sum(csa, na.rm = T)) %>% 
  .$tot %>% 
  order
col_sz <- mutate(col_sz,
    station_code = as.character(station_code),
    station_code = factor(station_code, levels = unique(station_code)[tmp])
    ) %>% 
  filter(!is.na(csa)) %>% 
  arrange(station_code, csa) %>%
  unite('statcol', station_code, ColonyID, sep = '_', remove = F) %>% 
  mutate(statcol = factor(statcol, levels = as.character(statcol)))

p <- ggplot(col_sz, aes(x = station_code, y = csa, group = statcol, fill = Recruits)) + 
  geom_bar(stat = 'identity', colour = 'grey') + 
  mythm +
  theme(legend.position = 'top') + 
  scale_x_discrete('Station') + 
  scale_y_continuous('CSA')
  
ggplotly()

set.seed(127)
tmp <- filter(col_sz, station_code %in% sample(station_code, 4))
p <- ggplot(tmp, aes(x = station_code, y = csa, group = statcol, fill = Recruits)) + 
  geom_bar(stat = 'identity', position = 'dodge', colour = 'grey') + 
  mythm +
  theme(legend.position = 'top') + 
  scale_x_discrete('Station') + 
  scale_y_continuous('CSA')
ggplotly()
```

#### Sensitive and rare species

This metric assesses the species composition and diversity of sensitive, rare species present (*Eusmilia*, *Isophyllastrea*, *Isophyllia*, *Mycetophyllia*, *Scolymia*) in the appropriate habitat type. The metric could be evaluated at each site as a richness estimate for the sensitive species, sum of the relative abundances, or as a diversity measure that accounts for both richness and abundance. Relative abundance was estimated as the number of observations for a species divided by the total number of observations. Diversity of sensitive species was estimated as Shannon diversity:

$$
D = -\sum_{i = 1}^{n} p_i \cdot log\left(p_i\right) 
$$
where i of n species are observed and p_i is the proportional abundance of each.  Only sixteen stations had sensitive species.

```{r warning = F, message = F, fig.height = 3, fig.width = 8}
# summary table for those with sens species
totab <- filter(crl_met, sr_rich > 0) %>% 
  rename(
    Station = station_code, 
    Richness = sr_rich, 
    `Relative abundance` = sr_rel_abu, 
    Diversity = sr_div
    )
pander::pander(totab)

# bar plot of relative abundance
toplo <- arrange(totab, `Relative abundance`) %>% 
  mutate(Station = factor(Station, levels = as.character(Station)))
p <- ggplot(toplo, aes(x = Station, y = `Relative abundance`)) + 
  geom_bar(stat = 'identity') + 
  mythm
ggplotly()
```

#### Disease, bleaching

Disease was recorded for individual corals as present/absence bleaching was recorded as absent, partial, and total. Both were summarized at each site as percent of individuals with disease or bleaching, i.e., sum of presence divided by total individuals.  Indidividuals with partial bleaching were assigned a value of 0.5.

```{r warning = F, message = F, fig.height = 5, fig.width = 8}
toplo <- filter(crl_met, diseased != 0 | bleached != 0)  %>% 
  arrange(bleached) %>% 
  mutate(station_code = factor(station_code, levels = as.character(station_code))) %>% 
  gather('var', 'val', bleached:diseased)

p <- ggplot(toplo, aes(x = station_code, y = val)) + 
  geom_bar(stat = 'identity') + 
  facet_wrap(~var, ncol = 1) + 
  scale_y_continuous('Proportion') + 
  scale_x_discrete('Station') + 
  mythm
ggplotly()
```

#### Dominance of *Orbicella* and *Acropora*

Dominance of *Orbicella* and *Acropora* genera was assessed as the sum of relative abundances of species at each site. This metric also refers to structural dominance of the species so it was also assessed as the sum of the surface area of all species in the genera divided by the total.

```{r warning = F, message = F, fig.height = 5, fig.width = 8}
toplo <- filter(crl_met, acrorb_rel_abu != 0 & acrorb_csa != 0) %>% 
  arrange(acrorb_csa) %>% 
  mutate(station_code = factor(station_code, levels = as.character(station_code))) %>% 
  rename(
    `Relative abundance` = acrorb_rel_abu,
    `Proportion CSA` = acrorb_csa
  ) %>% 
  gather('var', 'val', `Relative abundance`:`Proportion CSA`)
p <- ggplot(toplo, aes(x = station_code, y = val)) + 
  geom_bar(stat = 'identity') + 
  facet_wrap(~var, ncol = 1) + 
  scale_y_continuous('Proportion') + 
  scale_x_discrete('Station') + 
  mythm
ggplotly()
```

